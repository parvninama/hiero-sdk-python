name: Code Coverage

on:
    push:
        branches: [main]
    pull_request:

permissions:
  contents: read

jobs:
    coverage:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  fetch-depth: 2

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
              with:
                  python-version: "3.11"

            - name: Install uv
              uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6

            - name: Install dependencies
              run: |
                  uv sync --all-extras --dev

            - name: Generate Proto Files
              run: uv run python generate_proto.py

            - name: Run unit tests and generate coverage report
              run: |
                  uv run pytest tests/unit \
                  --cov=src \
                  --cov-report=xml \
                  --cov-report=term-missing

            - name: Upload coverage to Codecov
              if: false
              uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
              with:
                  files: coverage.xml
                  fail_ci_if_error: true
